<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- titulo pagina -->
    <title>| Dashboard</title>
    <!-- link chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <!-- logo site -->
    <link rel="icon" href="assets/icon/logoSite.png">
    <!-- link css -->
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
    <header class="navbar">
        <img id="logoIndex" src="assets/icon/logoNome.png">
        <nav> 
            <ul class="menu">
                <li class="item home"><a href="indexUsuario.html">Home</a></li>
                <li class="item franquia"><a href="franquia.html">Franquia</a></li>
                <li class="item sobre small"><a href="sobreMim.html">Sobre mim</a></li>
                <li class="item quiz"><a href="quiz.html">Quiz +</a></li>
            </ul>
        </nav>
    </header>

        <div class="dashboard">
            
            <div class="container">
                <a href="quiz.html" class="sair-quiz"><img src="assets/icon/dashboard/setaVoltar.png">Sair do QUIZ</a>
                <div class="saida-quiz">
                    <h1>Você é totalmente</h1>
                    <h2 id="nomePersonagem">DRACULAURA</h2>
                </div>
            </div>
        
            <div class="grafico">
                <div class="kpis">
                    <div id="kpi">
                        <p>Fofa</p>
                    </div><br>
                    <div id="kpi">
                        <p>Leal</p>
                    </div><br>
                    <div id="kpi">
                        <p>Amizade Verdadeira</p>
                    </div>
                </div>
                <div>
                    <canvas id="myChart" style="position: relative; height:40vh; width:55vw"></canvas>
                </div>
            </div>
        </div>

        <div class="footer">
            <div id="direitos">
                <span>Todos os direitos reservados a <span id="marca">MATTEL</span></span>
                <p id="marcaDAgua">By Nick :)</p>
            </div>
        </div>
</body>
<script>
    let nomePersonagens = [];
    let pontuacaoPorPersonagem = [];

    fetch("/buscarQuiz/buscarQuiz", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(function (resposta) {
            console.log("Peguei as pontuações para o gráfico");

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);

                    for (let i = 0; i < json.length; i++) {
                        nomePersonagens.push(json[i].Personagem);
                        pontuacaoPorPersonagem.push(json[i].Porcentagem);
                    }

                    const ctx = document.getElementById('myChart');
                    new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: nomePersonagens,
                            datasets: [{
                                label: 'Compatibilidade',
                                data: pontuacaoPorPersonagem,
                                backgroundColor: [
                                    "#3581AA", // Frankie
                                    "#1D9DA9", // Lagoona
                                    "#DC1A73", // Draculaura
                                    "#8252C0", // Clawdeen
                                    "#B29438"  // Cleo
                                ],
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            aspectRatio: 2,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        boxWidth: 20,
                                        color: 'white',
                                        font: {
                                            weight: 'bold',
                                            size: 16
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Personagens',
                                        font: {
                                            size: 20,
                                            weight: 'bold'
                                        },
                                        color: 'white'
                                    }
                                },
                                datalabels: {
                                    color: 'white',
                                    font: {
                                        family: 'Passion One',
                                        weight: 'bold',
                                        size: 23
                                    },
                                    formatter: (value, context) => {
                                        const total = context.dataset.data.reduce((a, b) => Number(a) + Number(b), 0);

                                        if (total == 0 || value == 0 || isNaN(total) || isNaN(value)) {
                                            return '';
                                        }

                                        const percentage = ((value / total) * 100).toFixed(1) + '%';
                                        return percentage;
                                    }
                                }
                            }
                        },
                        plugins: [ChartDataLabels],
                    });
                });
            } else {
                console.log("Houve um erro ao exibir os dados no gráfico");
            }
        })
        .catch(function (erro) {
            console.log(erro);
        });

</script>
</html>